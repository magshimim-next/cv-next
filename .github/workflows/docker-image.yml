name: Docker Image CICD

on:
  push:
    branches: ["feature/devopsBranch"]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generating env file
        run: cat ${{ secrets.ENV_CONTENT }} > ./cv_next/.env.local
      - name: Build the Docker image
        run: docker build ./cv_next --file ./cv_next/Dockerfile --tag ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPONAME }}:${{ secrets.DOCKERHUB_TAG }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      - name: pushing the image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPONAME }}:${{ secrets.DOCKERHUB_TAG }}
      - name: finishing the creating image
        run: echo "finished building and integrating the code in the image"

      - name: CD PIPE - rebuilding the app - bro what
        run: 'curl -s -o /dev/null -H "Content-Type: application/json" -H "Authorization: Bearer ${{ secrets.DIGITALOCEAN_TOKEN }}" "https://api.digitalocean.com/v2/apps/${{ secrets.DIGITALOCEAN_DP_ID }}/deployments" -XPOST -d ''{"force_build": true}'''
